//     (c) 2012 Raymond Julin, Keyteq AS
//     Backbone.touch may be freely distributed under the MIT license.

(function(e,t){typeof define=="function"&&define.amd?define(["underscore","backbone"],function(){return t.apply(e,arguments)}):typeof module=="object"&&module.exports?module.exports=t.call(e,require("underscore"),require("backbone")):t.call(e,e._,e.Backbone)})(typeof global=="object"?global:this,function(e,t){var n=function(t,n){return!t||!t[n]?null:e.isFunction(t[n])?t[n]():t[n]},r=/^(\S+)\s*(.*)$/;return e.extend(t.View.prototype,{_touching:!1,touchPrevents:!0,touchThreshold:10,isTouch:this.document&&"ontouchstart"in this.document&&!("callPhantom"in this),delegateEvents:function(t){if(!t&&!(t=n(this,"events")))return;this.undelegateEvents();var i=".delegateEvents"+this.cid;e(t).each(function(n,s){e.isFunction(n)||(n=this[t[s]]);if(!n)throw new Error('Method "'+t[s]+'" does not exist');var o=s.match(r),u=o[1],a=o[2],f=e.bind(this._touchHandler,this);n=e.bind(n,this),this._useTouchHandlers(u,a)?(this.$el.on("touchstart"+i,a,f),this.$el.on("touchend"+i,a,{method:n},f)):(u+=i,a===""?this.$el.bind(u,n):this.$el.on(u,a,n))},this)},_useTouchHandlers:function(e,t){return this.isTouch&&e==="click"},_touchHandler:function(e){if(!("changedTouches"in e.originalEvent))return;var t=e.originalEvent.changedTouches[0],n=t.clientX,r=t.clientY;switch(e.type){case"touchstart":this._touching=[n,r];break;case"touchend":var i=this._touching[0],s=this._touching[1],o=this.touchThreshold;if(n<i+o&&n>i-o&&r<s+o&&r>s-o){this._touching=!1;if(this.touchPrevents){var u=e.currentTarget.tagName;if(u==="BUTTON"||u==="A")e.preventDefault(),e.stopPropagation()}e.data.method(e)}}}}),t});